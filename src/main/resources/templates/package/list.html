<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

 <head th:replace="~{/layout/header::head('패키지상품리스트')}"></head>
<style>
  .card {
      width: 18rem;
      margin-bottom: 20px;
  }

  .admin_btn {
      display: flex;
      justify-content: flex-end;
  }
  
  .btn-kong {
    background-color: #96B6C5;
    color:white;
      }
  .card-title {
    font-size: 20px;
    font-weight: 400;
  }
  .btn-outline-kong {
    color: rgb(23, 62, 104);
  } 

</style>  
<body>

  <div th:replace="~{/layout/header::header}"></div>

  <div class="container text-center">  <!-- 그리드 시작 -->  
  <div class="row">
    <div class="col-1">    
    </div>
    <div class="col-10" >
      
   <!--  <th:block th:if="session.user.auth == 0}">  -->
      <a th:href="@{/package/write.form}">
        <button type="button" class="admin_btn" style="margin-left: auto;">게시글 작성</button>
      </a> 
    <!--  </th:block> -->
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display: inline-block;"> 
         <span th:text="${count}"></span>개의 상품
        </div>
        <div class="btn-group btn-group-sm" role="group" aria-label="Small button group" style="display: inline-block;">
          <button type="button" class="btn btn-outline-kong" id="new">최신순</button>
          <button type="button" class="btn btn-outline-kong" id="recommend">추천순</button>
          <button type="button" class="btn btn-outline-kong" id="priceLow">가격낮은순</button>
          <button type="button" class="btn btn-outline-kong" id="priceHigh">가격높은순</button>
        </div>
      </div>
      <hr>
      <div class="container">
        <div class="row" id="package_list"> 
          
        </div>
      </div>
      
      

      
    </div>
    <div class="col-1">      
    </div>
  </div>
  </div>

<script th:inline="javascript">
    // 전역 변수
    var page = 1;
    var totalPage = 0;
    var param = 0;
    
    function toggleRecommendStatus() {
    const currentURL = new URL('/package/getList.do', window.location.origin);
    const recommendStatus = currentURL.searchParams.get('recommendStatus') === '1' ? '0' : '1';

    // URL에 파라미터 추가
    currentURL.searchParams.set('recommendStatus', recommendStatus);

    // 서버로 요청 보내기
    fetch(currentURL.href)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log(data);

            // 추천 상태를 토글한 후에 fnGetPackageList 호출
            param = recommendStatus;
            fnGetPackageList(param);
        })
        .catch(error => console.error('Error:', error));
}


  // 이벤트 리스너 등록
  document.getElementById('recommend').addEventListener('click', toggleRecommendStatus);
  
    document.getElementById('new').addEventListener('click', function (event) {
        event.preventDefault();
        param = 'defaultCondition'; 
        changeUrlParameter('condition', param);
        fnGetPackageList(param);
    });

    document.getElementById('priceLow').addEventListener('click', function (event) {
        event.preventDefault();
        param = 'rowPrice';  
        changeUrlParameter('condition', param);
        fnGetPackageList(param);
    });

    document.getElementById('priceHigh').addEventListener('click', function (event) {
        event.preventDefault();
        param = 'highPrice';  
        changeUrlParameter('condition', param);
        fnGetPackageList(param);
    });


    const changeUrlParameter = (parameterName, parameterValue, callback) => {
	    var currentUrl = window.location.href;
	    var url = new URL(currentUrl);
	    url.searchParams.set(parameterName, parameterValue);	
	    window.history.pushState({}, '', url.href); 
	
	};


    const fnGetPackageList = (param) => {
        $.ajax({
            type: 'get',
            url: '/package/getList.do',
            data: {
                page: page,
                condition: param
            },
            dataType: 'json',
            success: (resData) => {
                totalPage = resData.totalPage;
                if (resData.packageList != null && resData.packageList.length > 0) {
                    $('#package_list').empty();
                    $.each(resData.packageList, (i, package) => {
                        let str = '<div class="col-md-4">';
                        str += '<div class="card">';
                        if (package.productImageDto && package.productImageDto.thumbnail === 1) {
                            str += '<img src="' + package.productImageDto.imagePath + '/' + package.productImageDto.filesystemName + '" style="height: 200px; " class="card-img-top" alt="Package Image">';
                        } else {
                            str += '<img src="https://github.com/skal48/portfolio/blob/main/bakdo.jpg?raw=true" style="height: 200px;" class="card-img-top" alt="Package Image">';
                        }
                        str += '<div class="card-body">';
                        str += '<p class="card-title">' + package.packageTitle + '</p>';
                        str += '<p class="card-text"></p>';
                        str += '<a href="' + '/package/increseHit.do?packageNo=' + package.packageNo + '" class="btn btn-kong">여행가기</a>';
                        str += '</div>';
                        str += '</div>';
                        str += '</div>';
                        $('#package_list').append(str);
                    });
                } else {
                    console.log('데이터가 없습니다.');
                }
            },
            error: (error) => {
                console.error('Ajax 요청 에러:', error);
            }
        });
    }

    const fnScroll = () => {
        var timerId;
        $(window).on('scroll', () => {
            if (timerId) {
                clearTimeout(timerId);
            }
            timerId = setTimeout(() => {
                let scrollTop = $(window).scrollTop();
                let windowHeight = $(window).height();
                let documentHeight = $(document).height();
                if ((scrollTop + windowHeight + 100) >= documentHeight) {
                    if (page > totalPage) {
                        return;
                    }
                    page++;
                    fnGetPackageList();
                }
            }, 200);
        })
    }

    fnGetPackageList(param);
    fnScroll();
</script>



    <div th:replace="~{/layout/footer::footer}"></div>

 
</body>
</html>

